<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Implementing a Resource</title><link type="text/css" rel="stylesheet" href="public/anatomy.css" /><link type="text/css" rel="stylesheet" href="public/highlight.css" /><script type="text/javascript" src="public/jquery.js"></script><script type="text/javascript" src="public/jquery.hotkeys.js"></script><script type="text/javascript" src="public/tags_implementing-resources.js"></script><script type="text/javascript" src="public/main.js"></script></head><body class="normal"><div id="main"><div id="content"><div class="section" id="section_implementing-resources"><h1 class="section_header"><a name="implementing-resources"></a>Implementing a Resource</h1><p>A resource type is implemented by a container image with three scripts:</p><ul><li><p><code>/opt/resource/check</code> for checking for new versions of the resource</p></li><li><p><code>/opt/resource/in</code> for pulling a version of the resource down</p></li><li><p><code>/opt/resource/out</code> for idempotently pushing a version up</p></li></ul><p>Distributing resource types as containers allows them to package their own
dependencies. For example, the Git resource comes with <code>git</code> installed.</p><p>All resources must implement all three actions, though the actions can just be
no-ops (which still must be correctly implemented as detailed below).</p><div class="section" id="section_check:-check-for-new-versions."><h2 class="section_header"><a name="check:-check-for-new-versions."></a><code>check</code>: Check for new versions.</h2><p>A resource type&#39;s <code>check</code> script is invoked to detect new versions of
the resource. It is given the configured source and current version on stdin,
and must print the array of new versions, in chronological order, to stdout.</p><p>Note that the current version will be missing if this is the first time the
resource has been used. In this case, the script should emit only the most
recent version, <em>not</em> every version since the resource&#39;s inception.</p><p>For example, here&#39;s what the input for a <code>git</code> resource may look like:</p><div class="highlight"><pre class="verbatim"><span class="p">{</span><span class="t">
  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t">
    </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;git://some-uri&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;branch&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;develop&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;private_key&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;...&quot;</span><span class="t">
  </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="t">
</span><span class="p">}</span></pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do
something like:</p><div class="highlight"><pre class="verbatim"><span class="o">[</span><span class="t"> </span><span class="t">-d</span><span class="t"> </span><span class="t">/tmp/repo</span><span class="t"> </span><span class="o">]</span><span class="t"> </span><span class="o">||</span><span class="t"> </span><span class="t">git</span><span class="t"> </span><span class="t">clone</span><span class="t"> </span><span class="t">git://some-uri</span><span class="t"> </span><span class="t">/tmp/repo</span><span class="t">
</span><span class="nb">cd</span><span class="t"> </span><span class="t">/tmp/repo</span><span class="t">
</span><span class="t">git</span><span class="t"> </span><span class="t">pull</span><span class="t"> </span><span class="o">&amp;&amp;</span><span class="t"> </span><span class="t">git</span><span class="t"> </span><span class="t">log</span><span class="t"> </span><span class="t">61cbef..HEAD</span></pre></div><p>Note that it conditionally clones; the container for checking versions is reused
between checks, so that it can efficiently pull rather than cloning every time.</p><p>And the output, assuming <code>d74e01</code> is the commit immediately after
<code>61cbef</code>:</p><div class="highlight"><pre class="verbatim"><span class="p">[</span><span class="t">
  </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;d74e01&quot;</span><span class="t"> </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;7154fe&quot;</span><span class="t"> </span><span class="p">}</span><span class="t">
</span><span class="p">]</span></pre></div><p>The list may be empty, if the given version is already the latest.</p></div><div class="section" id="section_in:-fetch-a-given-resource."><h2 class="section_header"><a name="in:-fetch-a-given-resource."></a><code>in</code>: Fetch a given resource.</h2><p>The <code>in</code> script is passed a destination directory as @code$1, and
is given on stdin the configured source and a precise version of the resource
to fetch.</p><p>The script must fetch the resource and place it in the given directory.</p><p>If the desired resource version is unavailable (for example, if it was
deleted), the script must error.</p><p>The script must emit the fetched version, and may emit metadata as a list of
key-value pairs. This data is intended for public consumption and will make it
upstream, intended to be shown on the build&#39;s page.</p><p>Example input, in this case for the <code>git</code> resource:</p><div class="highlight"><pre class="verbatim"><span class="p">{</span><span class="t">
  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t">
    </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;git://some-uri&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;branch&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;develop&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;private_key&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;...&quot;</span><span class="t">
  </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="t">
</span><span class="p">}</span></pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do
something like:</p><div class="highlight"><pre class="verbatim"><span class="t">git</span><span class="t"> </span><span class="t">clone</span><span class="t"> </span><span class="t">--branch</span><span class="t"> </span><span class="t">develop</span><span class="t"> </span><span class="t">git://some-uri</span><span class="t"> </span><span class="nv">$1</span><span class="t">
</span><span class="nb">cd</span><span class="t"> </span><span class="nv">$1</span><span class="t">
</span><span class="t">git</span><span class="t"> </span><span class="t">checkout</span><span class="t"> </span><span class="t">61cebf</span></pre></div><p>And output:</p><div class="highlight"><pre class="verbatim"><span class="p">{</span><span class="t">
  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">[</span><span class="t">
    </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;commit&quot;</span><span class="p">,</span><span class="t"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="p">,</span><span class="t">
    </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;author&quot;</span><span class="p">,</span><span class="t"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;Hulk Hogan&quot;</span><span class="t"> </span><span class="p">}</span><span class="t">
  </span><span class="p">]</span><span class="t">
</span><span class="p">}</span></pre></div></div><div class="section" id="section_out:-update-a-resource."><h2 class="section_header"><a name="out:-update-a-resource."></a><code>out</code>: Update a resource.</h2><p>The <code>out</code> script is called with a path to the directory containing the
build&#39;s full set of sources as the first argument, and is given on stdin the
configured params and the resource&#39;s source configuration.</p><p>The script must emit the resulting version of the resource. For example, the
<code>git</code> resource emits the sha of the commit that it just pushed.</p><p>Additionally, the script may emit metadata as a list of key-value pairs. This
data is intended for public consumption and will make it upstream, intended to
be shown on the build&#39;s page.</p><p>Example input, in this case for the <code>git</code> resource:</p><div class="highlight"><pre class="verbatim"><span class="p">{</span><span class="t">
  </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t">
    </span><span class="nt">&quot;branch&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;develop&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;repo&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;some-repo&quot;</span><span class="t">
  </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t">
    </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;git@...&quot;</span><span class="p">,</span><span class="t">
    </span><span class="nt">&quot;private_key&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;...&quot;</span><span class="t">
  </span><span class="p">}</span><span class="t">
</span><span class="p">}</span></pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do something
like:</p><div class="highlight"><pre class="verbatim"><span class="nb">cd</span><span class="t"> </span><span class="nv">$1</span><span class="t">/some-repo</span><span class="t">
</span><span class="t">git</span><span class="t"> </span><span class="t">push</span><span class="t"> </span><span class="t">origin</span><span class="t"> </span><span class="t">develop</span></pre></div><p>And output:</p><div class="highlight"><pre class="verbatim"><span class="p">{</span><span class="t">
  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;ref&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="p">,</span><span class="t">
  </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="t"> </span><span class="p">[</span><span class="t">
    </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;commit&quot;</span><span class="p">,</span><span class="t"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;61cebf&quot;</span><span class="t"> </span><span class="p">}</span><span class="p">,</span><span class="t">
    </span><span class="p">{</span><span class="t"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;author&quot;</span><span class="p">,</span><span class="t"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="t"> </span><span class="s2">&quot;Mick Foley&quot;</span><span class="t"> </span><span class="p">}</span><span class="t">
  </span><span class="p">]</span><span class="t">
</span><span class="p">}</span></pre></div></div></div></div></div><div class="search"><form action="javascript:void(0)"><input type="text" placeholder="Search&hellip;" autocomplete="off" id="search" /></form><ul class="search_results"></ul></div><div id="sidebar"><h4>On this page:</h4><ol class="toc"><li><a href="implementing-resources.html#check:-check-for-new-versions."><code>check</code>: Check for new versions.</a></li><li><a href="implementing-resources.html#in:-fetch-a-given-resource."><code>in</code>: Fetch a given resource.</a></li><li><a href="implementing-resources.html#out:-update-a-resource."><code>out</code>: Update a resource.</a></li></ol><h4>Up one level:</h4><ol class="toc"><li><a href="index.html">Concourse: CI that scales with your project</a><ol><li><a href="what-and-why.html">What &amp; Why</a><ol><li><a href="what-and-why.html#simple">Simple</a></li><li><a href="what-and-why.html#usable">Usable</a></li><li><a href="what-and-why.html#isolated-builds">Isolated Builds</a></li><li><a href="what-and-why.html#scalable-reproducible-deployment">Scalable, reproducible deployment</a></li><li><a href="what-and-why.html#flexible">Flexible</a></li><li><a href="what-and-why.html#local-iteration">Local iteration</a></li><li><a href="what-and-why.html#bootstrapped">Bootstrapped</a></li></ol></li><li><a href="concepts.html">Concepts</a><ol><li><a href="tasks.html">Tasks</a><ol><li><a href="tasks.html#runtime-environment">Runtime Environment</a></li></ol></li><li><a href="resources.html">Resources</a></li><li><a href="jobs.html">Jobs</a><ol><li><a href="jobs.html#job-builds">Builds</a></li></ol></li></ol></li><li><a href="getting-started.html">Getting Started</a><ol><li><a href="getting-started.html#deploying-with-vagrant">Provisioning with Vagrant</a></li><li><a href="getting-started.html#deploying-with-bosh">Deploying a cluster with BOSH</a><ol><li><a href="getting-started.html#setting-up-the-infrastructure">Setting up the infrastructure</a><ol><li><a href="getting-started.html#bosh-lite">BOSH-Lite</a></li><li><a href="getting-started.html#aws">AWS</a></li><li><a href="getting-started.html#vsphere-openstack">vSphere, OpenStack</a></li></ol></li><li><a href="getting-started.html#deploying-and-upgrading-concourse">Deploying and upgrading Concourse</a><ol><li><a href="getting-started.html#upload-the-stemcell">Upload the stemcell</a></li><li><a href="getting-started.html#upload-the-concourse-and-garden-releases">Upload the Concourse &amp; Garden releases</a></li><li><a href="getting-started.html#bosh-properties">Configure &amp; Deploy</a></li></ol></li></ol></li></ol></li><li><a href="fly-cli.html">The Fly CLI</a><ol><li><a href="fly-cli.html#targeting-your-concourse">Targeting your Concourse</a></li><li><a href="fly-cli.html#fly-save-target"><code>save-target</code>: Saving Concourse Targets</a></li><li><a href="fly-cli.html#fly-execute"><code>execute</code>: Submitting Local Tasks</a><ol><li><a href="fly-cli.html#multiple-inputs-to-locally-submitted-tasks">Multiple Inputs to Locally Submitted Tasks</a></li></ol></li><li><a href="fly-cli.html#fly-configure"><code>configure</code>: Configuring Pipelines</a><ol><li><a href="fly-cli.html#parameters">Parameters</a></li></ol></li><li><a href="fly-cli.html#fly-destroy-pipeline"><code>destroy-pipeline</code>: Removing Pipelines</a></li><li><a href="fly-cli.html#fly-intercept"><code>intercept</code>: Accessing a running or recent build&#39;s steps</a></li><li><a href="fly-cli.html#fly-sync"><code>sync</code>: Update your local copy of @codefly</a></li><li><a href="fly-cli.html#fly-watch"><code>watch</code>: View logs of in-progress builds</a></li></ol></li><li><a href="running-tasks.html">Tasks</a><ol><li><a href="running-tasks.html#configuring-tasks">Configuring a Task</a></li><li><a href="running-tasks.html#fly">Running tasks with <code>fly</code></a></li></ol></li><li><a href="pipelines.html">Piplines</a><ol><li><a href="configuring-resources.html"><code>resources</code>: Objects flowing through the pipeline</a></li><li><a href="configuring-jobs.html"><code>jobs</code>: Plans to execute against resources</a></li><li><a href="configuring-groups.html"><code>groups</code>: Splitting up your pipeline into sections</a></li></ol></li><li><a href="build-plans.html">Build Plans</a><ol><li><a href="get-step.html"><code>get</code>: fetch a resource</a></li><li><a href="put-step.html"><code>put</code>: update a resource</a></li><li><a href="task-step.html"><code>task</code>: execute a task</a></li><li><a href="aggregate-step.html"><code>aggregate</code>: run steps in parallel</a></li><li><a href="do-step.html"><code>do</code>: run steps in series</a></li><li><a href="step-conditions.html"><code>conditions</code>: conditionally perform a step</a></li></ol></li><li><a href="implementing-resources.html">Implementing a Resource</a><ol><li><a href="implementing-resources.html#check:-check-for-new-versions."><code>check</code>: Check for new versions.</a></li><li><a href="implementing-resources.html#in:-fetch-a-given-resource."><code>in</code>: Fetch a given resource.</a></li><li><a href="implementing-resources.html#out:-update-a-resource."><code>out</code>: Update a resource.</a></li></ol></li></ol></li></ol></div></body></html>